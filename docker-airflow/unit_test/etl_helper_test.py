import unittest
import pandas as pd
import json
from unittest.mock import MagicMock, patch
import etl_helper

# ingest("https://r2de2-workshop-vmftiryt6q-ts.a.run.app/usd_thb_conversion_rate")
# etl_helper.fetch_data("https://r2de2-workshop-vmftiryt6q-ts.a.run.app/usd_thb_conversion_rate")
class ETLHelperTest(unittest.TestCase):
    @patch('etl_helper.fetch_data')
    def test_fetch_data(self, mock_fetch_data):
        mock_fetch_data.return_value = MagicMock(status_code=200, response=json.dumps({'key':'value'})) 
        request = etl_helper.fetch_data("https://r2de2-workshop-vmftiryt6q-ts.a.run.app/usd_thb_conversion_rate")
        self.assertEqual(request.status_code, 200)

    @patch('etl_helper.fetch_data')
    def test_convert_data_to_json(self, mock_fetch_data):
        mock_fetch_data.return_value = MagicMock(status_code=200, response=json.dumps({'key':'value'}))
        request = etl_helper.fetch_data("https://r2de2-workshop-vmftiryt6q-ts.a.run.app/usd_thb_conversion_rate")
        self.assertEqual(etl_helper.convert_data_to_json(request), request.json())

    def test_convert_json_to_df(self):
        mock_data = {"conversion_rate": {"2021-08-12": 33.084, "2021-08-11": 33.145, "2021-08-10": 33.46, "2021-08-09": 33.464, "2021-08-08": 33.395, "2021-08-07": 33.422, "2021-08-06": 33.45, "2021-08-05": 33.263, "2021-08-04": 33.137, "2021-08-03": 33.022, "2021-08-02": 32.957, "2021-08-01": 32.895, "2021-07-31": 32.887, "2021-07-30": 32.887, "2021-07-29": 32.87, "2021-07-28": 32.82, "2021-07-27": 32.937, "2021-07-26": 32.929, "2021-07-25": 32.94, "2021-07-24": 32.963, "2021-07-23": 32.928, "2021-07-22": 32.887, "2021-07-21": 32.857, "2021-07-20": 32.829, "2021-07-19": 32.854, "2021-07-18": 32.807, "2021-07-17": 32.795, "2021-07-16": 32.783, "2021-07-15": 32.686, "2021-07-14": 32.605, "2021-07-13": 32.654, "2021-07-12": 32.664, "2021-07-11": 32.506, "2021-07-10": 32.482, "2021-07-09": 32.512, "2021-07-08": 32.534, "2021-07-07": 32.334, "2021-07-06": 32.271, "2021-07-05": 32.112, "2021-07-04": 32.136, "2021-07-03": 32.125, "2021-07-02": 32.126, "2021-07-01": 32.073, "2021-06-30": 32.029, "2021-06-29": 32.108, "2021-06-28": 31.918, "2021-06-27": 31.785, "2021-06-26": 31.816, "2021-06-25": 31.816, "2021-06-24": 31.898, "2021-06-23": 31.825, "2021-06-22": 31.681, "2021-06-21": 31.617, "2021-06-20": 31.461, "2021-06-19": 31.437, "2021-06-18": 31.439, "2021-06-17": 31.422, "2021-06-16": 31.297, "2021-06-15": 31.162, "2021-06-14": 31.117, "2021-06-13": 31.077, "2021-06-12": 31.074, "2021-06-11": 31.092, "2021-06-10": 31.14, "2021-06-09": 31.167, "2021-06-08": 31.202, "2021-06-07": 31.176, "2021-06-06": 31.133, "2021-06-05": 31.125, "2021-06-04": 31.125, "2021-06-03": 31.209, "2021-06-02": 31.108, "2021-06-01": 31.169, "2021-05-31": 31.193, "2021-05-30": 31.238, "2021-05-29": 31.252, "2021-05-28": 31.257, "2021-05-27": 31.297, "2021-05-26": 31.281, "2021-05-25": 31.328, "2021-05-24": 31.323, "2021-05-23": 31.37, "2021-05-22": 31.361, "2021-05-21": 31.361, "2021-05-20": 31.378, "2021-05-19": 31.413, "2021-05-18": 31.42, "2021-05-17": 31.492, "2021-05-16": 31.365, "2021-05-15": 31.33, "2021-05-14": 31.33, "2021-05-13": 31.344, "2021-05-12": 31.304, "2021-05-11": 31.158, "2021-05-10": 31.107, "2021-05-09": 31.033, "2021-05-08": 31.042, "2021-05-07": 31.042, "2021-05-06": 31.226, "2021-05-05": 31.13, "2021-05-04": 31.188, "2021-05-03": 31.132, "2021-05-02": 31.122, "2021-05-01": 31.14, "2021-04-30": 31.139, "2021-04-29": 31.197, "2021-04-28": 31.344, "2021-04-27": 31.355, "2021-04-26": 31.427, "2021-04-25": 31.421, "2021-04-24": 31.411, "2021-04-23": 31.412, "2021-04-22": 31.378, "2021-04-21": 31.3, "2021-04-20": 31.281, "2021-04-19": 31.203, "2021-04-18": 31.226, "2021-04-17": 31.204, "2021-04-16": 31.203, "2021-04-15": 31.165, "2021-04-14": 31.329, "2021-04-13": 31.496, "2021-04-12": 31.482, "2021-04-11": 31.462, "2021-04-10": 31.454, "2021-04-09": 31.451, "2021-04-08": 31.433, "2021-04-07": 31.387, "2021-04-06": 31.288, "2021-04-05": 31.342, "2021-04-04": 31.244, "2021-04-03": 31.256, "2021-04-02": 31.29, "2021-04-01": 31.194}}
        mock_df = pd.DataFrame(mock_data)
        df = etl_helper.convert_json_to_df(mock_data)
        self.assertEqual(type(df), type(mock_df))

    def test_adjust_columns(self):
        mock_data = {"conversion_rate": {"2021-08-12": 33.084, "2021-08-11": 33.145, "2021-08-10": 33.46, "2021-08-09": 33.464, "2021-08-08": 33.395, "2021-08-07": 33.422, "2021-08-06": 33.45, "2021-08-05": 33.263, "2021-08-04": 33.137, "2021-08-03": 33.022, "2021-08-02": 32.957, "2021-08-01": 32.895, "2021-07-31": 32.887, "2021-07-30": 32.887, "2021-07-29": 32.87, "2021-07-28": 32.82, "2021-07-27": 32.937, "2021-07-26": 32.929, "2021-07-25": 32.94, "2021-07-24": 32.963, "2021-07-23": 32.928, "2021-07-22": 32.887, "2021-07-21": 32.857, "2021-07-20": 32.829, "2021-07-19": 32.854, "2021-07-18": 32.807, "2021-07-17": 32.795, "2021-07-16": 32.783, "2021-07-15": 32.686, "2021-07-14": 32.605, "2021-07-13": 32.654, "2021-07-12": 32.664, "2021-07-11": 32.506, "2021-07-10": 32.482, "2021-07-09": 32.512, "2021-07-08": 32.534, "2021-07-07": 32.334, "2021-07-06": 32.271, "2021-07-05": 32.112, "2021-07-04": 32.136, "2021-07-03": 32.125, "2021-07-02": 32.126, "2021-07-01": 32.073, "2021-06-30": 32.029, "2021-06-29": 32.108, "2021-06-28": 31.918, "2021-06-27": 31.785, "2021-06-26": 31.816, "2021-06-25": 31.816, "2021-06-24": 31.898, "2021-06-23": 31.825, "2021-06-22": 31.681, "2021-06-21": 31.617, "2021-06-20": 31.461, "2021-06-19": 31.437, "2021-06-18": 31.439, "2021-06-17": 31.422, "2021-06-16": 31.297, "2021-06-15": 31.162, "2021-06-14": 31.117, "2021-06-13": 31.077, "2021-06-12": 31.074, "2021-06-11": 31.092, "2021-06-10": 31.14, "2021-06-09": 31.167, "2021-06-08": 31.202, "2021-06-07": 31.176, "2021-06-06": 31.133, "2021-06-05": 31.125, "2021-06-04": 31.125, "2021-06-03": 31.209, "2021-06-02": 31.108, "2021-06-01": 31.169, "2021-05-31": 31.193, "2021-05-30": 31.238, "2021-05-29": 31.252, "2021-05-28": 31.257, "2021-05-27": 31.297, "2021-05-26": 31.281, "2021-05-25": 31.328, "2021-05-24": 31.323, "2021-05-23": 31.37, "2021-05-22": 31.361, "2021-05-21": 31.361, "2021-05-20": 31.378, "2021-05-19": 31.413, "2021-05-18": 31.42, "2021-05-17": 31.492, "2021-05-16": 31.365, "2021-05-15": 31.33, "2021-05-14": 31.33, "2021-05-13": 31.344, "2021-05-12": 31.304, "2021-05-11": 31.158, "2021-05-10": 31.107, "2021-05-09": 31.033, "2021-05-08": 31.042, "2021-05-07": 31.042, "2021-05-06": 31.226, "2021-05-05": 31.13, "2021-05-04": 31.188, "2021-05-03": 31.132, "2021-05-02": 31.122, "2021-05-01": 31.14, "2021-04-30": 31.139, "2021-04-29": 31.197, "2021-04-28": 31.344, "2021-04-27": 31.355, "2021-04-26": 31.427, "2021-04-25": 31.421, "2021-04-24": 31.411, "2021-04-23": 31.412, "2021-04-22": 31.378, "2021-04-21": 31.3, "2021-04-20": 31.281, "2021-04-19": 31.203, "2021-04-18": 31.226, "2021-04-17": 31.204, "2021-04-16": 31.203, "2021-04-15": 31.165, "2021-04-14": 31.329, "2021-04-13": 31.496, "2021-04-12": 31.482, "2021-04-11": 31.462, "2021-04-10": 31.454, "2021-04-09": 31.451, "2021-04-08": 31.433, "2021-04-07": 31.387, "2021-04-06": 31.288, "2021-04-05": 31.342, "2021-04-04": 31.244, "2021-04-03": 31.256, "2021-04-02": 31.29, "2021-04-01": 31.194}}
        mock_df = pd.DataFrame(mock_data)
        adjusted_df = etl_helper.adjust_columns(mock_df)
        self.assertEqual('date' in adjusted_df.columns, True) 

if __name__ == '__main__':
    unittest.main()